---
import MediaViewer from "./MediaViewer.svelte";
const BASE_URL = import.meta.env.BASE_URL;
const { caseItem, Content } = Astro.props;

// все медиафайлы в один массив
let allMedia = [];
if (caseItem.data.cover) {
    allMedia.push(caseItem.data.cover);
}
if (caseItem.data.media) {
    allMedia = allMedia.concat(caseItem.data.media);
}

function isVideo(url: string) {
    return url && url.toLowerCase().endsWith(".mp4");
}

function getPosterUrl(media: string) {
    const regex = new RegExp("\\.mp4$");
    const res = media.replace(regex, ".webp");
    return `${BASE_URL}${res}`;
}
---

<div class="case-page">
    <div class="case-page__header container">
        <h1 class="case-page__title">{caseItem.data.title}</h1>
        <p class="case-page__descr">{caseItem.data.descr}</p>
    </div>
    <div class="case-page__media">
        {
            allMedia.map((media) => (
                <MediaViewer client:load mediaUrl={`${BASE_URL}${media}`}>
                    {isVideo(media) ? (
                        <video
                            src={`${BASE_URL}${media}`}
                            preload="metadata"
                            poster={getPosterUrl(media)}
                            playsinline
                            data-fetchpriority="low"
                            class="case-page__media__card"
                        />
                    ) : (
                        <img
                            src={`${BASE_URL}${media}`}
                            alt={caseItem.data.title}
                            class="case-page__media__card"
                        />
                    )}
                </MediaViewer>
            ))
        }
    </div>

    <div class="case-page__content container">
        <Content />
    </div>
</div>

<style lang="scss">
    @use "../styles/h1-title" as *;
    @use "../styles/md-text" as md;

    $border_radius: 2rem;
    $padding_in_item: 0.6rem;

    .case-page {
        &__content {
            @include md.message-shared($padding_in_item, $border_radius);
            max-width: 1000px;
            padding: clamp(0.8em, 3vw, 2em);
            background-color: var(--color-black);
            border-radius: 1em;
            margin-bottom: 5em;
        }

        &__header {
            padding: 2em 0;
            text-align: center;
            @include title-h1;
        }

        &__media {
            justify-self: center;
            overflow-x: scroll;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            display: flex;
            gap: 1em;

            scroll-snap-align: center;
            max-width: 100%;

            margin: 2em 0;

            &::-webkit-scrollbar {
                width: 0px;
                height: 0px;
            }

            :global(.case-page__media__card) {
                max-height: 150px;
                border-radius: calc($border_radius / 2);
            }

            :global(.media-viewer) {
                scroll-snap-align: center;
            }
        }
    }
</style>
