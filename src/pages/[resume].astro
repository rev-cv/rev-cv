---
import Layout from "../layouts/Layout.astro";
import HeroBanner from "../components/HeroBanner.astro";
import AboutMe from "../components/AboutMeCards.astro";
import type { TypePortfoliosGlob, PortfolioItem } from "../types/TypePortfolio";

/**
 * Генерирует статические пути для всех доступных резюме
 */
export async function getStaticPaths() {
    const portfoliosJSON: TypePortfoliosGlob = import.meta.glob(
        "../data/portfolios/*.json",
        {
            eager: true,
        }
    );

    const allPortfolios: PortfolioItem[] = [];
    for (const path in portfoliosJSON) {
        const portfolio = portfoliosJSON[path].default;
        allPortfolios.push(portfolio);
    }

    return allPortfolios.map((portfolio) => ({
        params: { resume: portfolio.url },
    }));
}

/**
 * Загружает все JSON файлы портфолио из папки portfolios
 * Использует import.meta.glob для динамической загрузки
 */
const portfoliosJSON: TypePortfoliosGlob = import.meta.glob(
    "../data/portfolios/*.json",
    {
        eager: true,
    }
);

/**
 * Создает массив всех доступных портфолио
 */
const allPortfolios: PortfolioItem[] = [];
for (const path in portfoliosJSON) {
    const portfolio = portfoliosJSON[path].default;
    allPortfolios.push(portfolio);
}

/**
 * Получает параметр resume из URL
 */
const { resume: resumeSlug } = Astro.params;

/**
 * Находит портфолио по URL slug
 */
const currentResume = allPortfolios.find(
    (portfolio) => portfolio.url === resumeSlug
);

/**
 * Если портфолио не найдено, возвращаем 404
 */
if (!currentResume) {
    return Astro.redirect("/404");
}

/**
 * Получает остальные портфолио для навигации
 */
const otherPortfolios = allPortfolios.filter(
    (portfolio) => portfolio.url !== resumeSlug
);
---

<Layout title={`${currentResume.jobtitle} - Ревин Роман`}>
    <HeroBanner resume={currentResume} />
    <AboutMe cards={currentResume.aboutme} />
</Layout>
