---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import HeroBanner from "../components/HeroBanner.astro";
import AboutMe from "../components/AboutMeCards.astro";
import Cases from "../components/Cases.astro";
import SkillsAndTools from "../components/SkillsAndTools.astro";
import Education from "../components/Education.astro";
import Roadmap from "../components/Roadmap.astro";
import Contacts from "../components/Contacts.astro";

// ↓ статические пути для всех доступных резюме
export async function getStaticPaths() {
    const allPortfolioEntries = await getCollection("portfolios");
    return allPortfolioEntries.map((entry) => ({
        params: { resume: entry.data.url },
    }));
}

// ↓ получить текущий slug из URL и по нему найти нужное портфолио
const allPortfolioEntries = await getCollection("portfolios");
const { resume: resumeSlug } = Astro.params;
const currentPortfolioEntry = allPortfolioEntries.find(
    (entry) => entry.data.url === resumeSlug
);

// если портфолио не найдено → 404
if (!currentPortfolioEntry) {
    return Astro.redirect("/404");
}

const currentResume = currentPortfolioEntry.data;

const caseImports = await Astro.glob("../content/cases/*.md");

const cases = (
    await Promise.all(
        caseImports
            .filter((c) => currentResume.cases.includes(c.frontmatter.url))
            .map(async (c) => ({
                data: c.frontmatter,
                htmlContent: await c.compiledContent(),
            }))
    )
).sort((a, b) => {
    const aIndex = currentResume.cases.indexOf(a.data.url);
    const bIndex = currentResume.cases.indexOf(b.data.url);
    return aIndex - bIndex;
});
---

<Layout
    title={`${currentResume.jobtitle} - Ревин Роман`}
    description={currentResume.description}
    cover={currentResume.cover}
    keywords={currentResume.keywords}
>
    <HeroBanner resume={currentResume} />
    <AboutMe cards={currentResume.aboutme} />
    <Cases cases={cases} />
    <SkillsAndTools
        title="Hard Skills"
        items={currentResume.skills}
        isSkills={true}
    />
    <Roadmap roadmap={currentResume.roadmap} />
    <SkillsAndTools title="Soft Skills" items={currentResume.quality} />
    <SkillsAndTools title="Инструменты" items={currentResume.tools} />
    <Education />
    <Contacts isBriefly={true} />
</Layout>
