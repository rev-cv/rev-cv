---
import Layout from "../layouts/Layout.astro";
import HeroBanner from "../components/HeroBanner.astro";
import AboutMe from "../components/AboutMeCards.astro";
import Cases from "../components/Cases.astro";
import SkillsAndTools from "../components/SkillsAndTools.astro";
import Education from "../components/Education.astro";
import Roadmap from "../components/Roadmap.astro";
import Contacts from "../components/Contacts.astro";

import type { TypePortfoliosGlob, PortfolioItem } from "../types/TypePortfolio";

// ↓ статические пути для всех доступных резюме
export async function getStaticPaths() {
    const portfoliosJSON: TypePortfoliosGlob = import.meta.glob(
        "../data/portfolios/*.json",
        { eager: true }
    );

    const allPortfolios: PortfolioItem[] = [];
    for (const path in portfoliosJSON) {
        const portfolio = portfoliosJSON[path].default;
        allPortfolios.push(portfolio);
    }

    return allPortfolios.map((portfolio) => ({
        params: { resume: portfolio.url },
    }));
}

// ↓ импорт всех JSON файлов с портфолио из папки portfolios
const portfoliosJSON: TypePortfoliosGlob = import.meta.glob(
    "../data/portfolios/*.json",
    { eager: true }
);
const allPortfolios: PortfolioItem[] = [];
for (const path in portfoliosJSON) {
    const portfolio = portfoliosJSON[path].default;
    allPortfolios.push(portfolio);
}

// ↓ получить текущий slug из URL и по нему найти нужное портфолио
const { resume: resumeSlug } = Astro.params;
const currentResume = allPortfolios.find(
    (portfolio) => portfolio.url === resumeSlug
);

// если портфолио не найдено → 404
if (!currentResume) {
    return Astro.redirect("/404");
}

// ↓ остальные портфолио для навигации
const otherPortfolios = allPortfolios.filter(
    (portfolio) => portfolio.url !== resumeSlug
);

const caseImports = await Astro.glob("../data/cases/*.md");
const allCases = await Promise.all(
    Object.values(caseImports).map(async (importCase) => ({
        metadata: importCase.frontmatter,
        htmlContent: await importCase.compiledContent(),
    }))
);

const cases = allCases
    .filter((c) => currentResume.cases.includes(c.metadata.url))
    .sort((a, b) => {
        const aIndex = currentResume.cases.indexOf(a.metadata.url);
        const bIndex = currentResume.cases.indexOf(b.metadata.url);
        return aIndex - bIndex;
    });
---

<Layout title={`${currentResume.jobtitle} - Ревин Роман`}>
    <HeroBanner resume={currentResume} />
    <AboutMe cards={currentResume.aboutme} />
    <Cases cases={cases} />
    <SkillsAndTools
        title="Hard Skills"
        items={currentResume.skills}
        isSkills={true}
    />
    <Roadmap roadmap={currentResume.roadmap} />
    <SkillsAndTools title="Soft Skills" items={currentResume.quality} />
    <SkillsAndTools title="Инструменты" items={currentResume.tools} />
    <Education />
    <Contacts />
</Layout>
